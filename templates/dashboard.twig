{% extends "base.twig" %}

{% block content %}
<div class="flex flex-col min-h-screen bg-gray-50">
  {% include "partials/dashboard_nav.twig" %}

  <main class="flex-1 max-w-[1440px] mx-auto w-full px-6 py-10">
    <div class="flex justify-between items-center mb-10">
      <h2 class="text-3xl font-bold text-gray-800">
        Dashboard
      </h2>
      <p class="text-gray-600 text-sm">
        Welcome, <span id="userEmail" class="font-medium"></span>
      </p>
    </div>

    <!-- Stats Cards -->
    <div id="statsCards" class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-10">
      <div class="bg-white p-6 rounded-2xl shadow">
        <h3 class="text-gray-600">Total Tickets</h3>
        <p id="totalTickets" class="text-3xl font-bold text-gray-800 mt-2">0</p>
      </div>

      <div class="bg-green-100 p-6 rounded-2xl shadow">
        <h3 class="text-gray-600">Open</h3>
        <p id="openTickets" class="text-3xl font-bold text-green-700 mt-2">0</p>
      </div>

      <div class="bg-amber-100 p-6 rounded-2xl shadow">
        <h3 class="text-gray-600">In Progress</h3>
        <p id="progressTickets" class="text-3xl font-bold text-amber-700 mt-2">0</p>
      </div>

      <div class="bg-gray-200 p-6 rounded-2xl shadow">
        <h3 class="text-gray-600">Closed</h3>
        <p id="closedTickets" class="text-3xl font-bold text-gray-700 mt-2">0</p>
      </div>
    </div>

    <!-- Navigation -->
    <div class="text-center">
      <a
        href="/?page=tickets"
        class="bg-blue-600 text-white px-8 py-3 rounded-2xl shadow hover:bg-blue-700 transition"
      >
        Manage Tickets
      </a>
    </div>
  </main>

  {% include "partials/footer.twig" %}
</div>

<!-- Scripts -->
<script src="/js/auth.js"></script>
<script src="/js/tickets.js"></script>
<script src="/js/toast.js"></script>
<script>
function updateDashboardStats() {
  const currentUser = JSON.parse(localStorage.getItem("current_user"));
  if (!currentUser) {
    showToast("Please log in to access your dashboard", "error");
    setTimeout(() => {
      window.location.href = "/?page=login";
    }, 1200);
    return;
  }

  // Show email
  const userEmailEl = document.getElementById("userEmail");
  if (userEmailEl) userEmailEl.textContent = currentUser.email;

  // Get all tickets
  const allTickets = JSON.parse(localStorage.getItem("tickets")) || [];
  const userTickets = allTickets.filter(t => t.owner === currentUser.email);

  // Calculate counts
  const total = userTickets.length;
  const open = userTickets.filter(t => t.status === "open").length;
  const inProgress = userTickets.filter(t => t.status === "in_progress").length;
  const closed = userTickets.filter(t => t.status === "closed").length;

  // Update UI
  document.getElementById("totalTickets").textContent = total;
  document.getElementById("openTickets").textContent = open;
  document.getElementById("progressTickets").textContent = inProgress;
  document.getElementById("closedTickets").textContent = closed;

  // Toast feedback
  showToast("Dashboard stats refreshed", "info");
}

// Run on page load
window.addEventListener("load", () => {
  updateDashboardStats();
  const currentUser = JSON.parse(localStorage.getItem("current_user"));
  if (currentUser) {
    showToast(`Welcome back, ${currentUser.email.split("@")[0]}!`, "success");
  }
});

// Recalculate when returning from another tab
document.addEventListener("visibilitychange", () => {
  if (document.visibilityState === "visible") {
    updateDashboardStats();
  }
});
</script>

{% endblock %}
